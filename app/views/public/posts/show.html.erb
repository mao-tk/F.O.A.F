<div class="container">
  <div class="row">
    <div class="card w-100">
      <div class="card-header bg-transparent">
        <div class="row">
        <div class="col align-self-start">
          <%= image_tag @post.user.get_profile_image(50,50), class: "rounded-circle border" %>
          <span class="h5 ml-3"><%= @post.user.name %></span>
        </div>
        <div class="col align-self-end text-right">
          <button type="button" class="btn border rounded-circle ml-3" data-toggle="modal" data-target="#bookmarkModal" data-whatever="@folder"><i class="fas fa-bookmark"></i></button><br>
          <%= @post.created_at %>
        </div>
        </div>
      </div>
      <div class="card-body">
        <h1 class="card-title"><%= @post.title %></h1>
        <div class="card-text"><%= simple_format(@post.body) %></div>
      </div>
      <div class="card-footer bg-transparent text-right">
        <% @post_tags.each do |tag| %>
          <%= link_to "#" do %>
            #<%=tag.name%>
          <% end %>
        <% end %>
      </div>
    </div>
  </div>
  <div class="row mt-3">
    <table class="table ">
      <% @post.comments.each do |comment| %>
        <tr>
          <td width="10%">
            <%= image_tag comment.user.get_profile_image(50,50), class: "rounded-circle border" %><br>
            <%= comment.user.name %>
          </td>
          <td width="90%">
            <div class="card">
              <div class="card-body">
                <div class="card-text">
                  <div id="js-comment-<%= comment.id %>">
                    <%= simple_format comment.content, id: "js-comment-label-"+(comment.id.to_s) %>
                    <%= simple_format "", id: "js-comment-post-error-"+(comment.id.to_s), class: "text-danger" %>
                    <textarea style="display: none;" id="js-textarea-comment-<%= comment.id %>" class="form-control comment-post-error"><%= comment.content %></textarea>
                    <div id="js-comment-button-<%= comment.id %>" style="display: none;">
                      <button data-cancel-id=<%= comment.id %> type="button" class="btn btn-sm btn-light comment-cancel-button">キャンセル</button>
                      <button data-update-id=<%= comment.id%> type="submit" class="btn btn-sm btn-info comment-update-button">更新</button>
                    </div>
                  </div>
                </div>
                <div class="text-right">
                  <% if comment.user == current_user %>
                    <span data-comment-id=<%= comment.id %> class="js-edit-comment-button">
                      <i class="fas fa-edit"></i>
                    </span>
                    <%= link_to post_comment_path(comment.post, comment), method: :delete, data: {confirm: "削除しますか？"} do %>
                      <i class="fas fa-trash text-dark"></i>
                    <% end %>
                  <% end %>
                </div>
              </div>
            </div>
          </td>
        </tr>
      <% end %>
    </table>
  </div>
  <div class="row mt-3">
    <%= form_with model: [@post, @comment] do |f| %>
      <%= f.text_area :content, rows: '3', placeholder: "コメントをここに", class: "form-control" %>
      <%= f.submit "送信", class: "btn border" %>
    <% end %>
  </div>
</div>


<!--ブックマーク追加用モーダル-->
<div class="modal fade" id="bookmarkModal" tabindex="-1" aria-labelledby="bookmarkModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="bookmarkModalLabel">ブックマークへ追加</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">×</span>
        </button>
      </div>
      <div class="modal-body">

        <% @folders.each do |folder| %>

            <%= link_to post_bookmark_path(@post,:folder_id=>folder.id), method: :post, class: "text-dark" do %>
              <i class="fas fa-folder-plus"></i><%= folder.name %><br>
            <% end %>


            <%= link_to post_bookmark_path(@post,:folder_id=>folder.id), method: :delete, class: "text-dark" do %>
              <i class="fas fa-folder-minus"></i><%= folder.name %><br>
            <% end %>

        <% end %>

      </div>
    </div>
  </div>
</div>


<script>
// コメント編集エリア表示
  $(function () {
    $(document).on("click", ".js-edit-comment-button", function () {
      const commentId = $(this).data('comment-id');
      const commentLabelArea = $('#js-comment-label-' + commentId);
      const commentTextArea = $('#js-textarea-comment-' + commentId);
      const commentButton = $('#js-comment-button-' + commentId);

      commentLabelArea.hide();
      commentTextArea.show();
      commentButton.show();
    });
  });

// コメント編集エリア非表示
  $(function () {
    $(document).on("click", ".comment-cancel-button", function () {
      const commentId = $(this).data('cancel-id');
      const commentLabelArea = $('#js-comment-label-' + commentId);
      const commentTextArea = $('#js-textarea-comment-' + commentId);
      const commentButton = $('#js-comment-button-' + commentId);
      const commentError = $('#js-comment-post-error-' + commentId);

      commentLabelArea.show();
      commentTextArea.hide();
      commentButton.hide();
      commentError.hide();
    });
  });

// コメント更新
  $(function () {
    $(document).on("click", ".comment-update-button", function () {
      const commentId = $(this).data('update-id');
      const textField = $('#js-textarea-comment-' + commentId);
      const body = textField.val();
      console.log(body);

      $.ajax({
        type: 'PATCH',
        url: 'posts/comments/' + commentId,
        data: {
          comment: {
            content: body
          }
        }
      }).done(function (data) {
          const commentLabelArea = $('#js-comment-label-' + commentId);
          const commentTextArea = $('#js-textarea-comment-' + commentId);
          const commentButton = $('#js-comment-button-' + commentId);
          const commentError = $('#js-comment-post-error-' + commentId);

          commentLabelArea.show();
          commentLabelArea.text(data.content);
          commentTextArea.hide();
          commentButton.hide();
          commentError.hide();
        }).fail(function () {
        const commentError = $('#js-comment-post-error-' + commentId);
        commentError.text('コメントを入力してください');
      })
    });
  });
</script>